apiVersion: policy.mcm.ibm.com/v1alpha1
kind: Policy
metadata:
  name: {{name}}
  namespace: {{namespace}}
  annotations:
    policy.mcm.ibm.com/standards: {{#each standards}}{{ this }}{{^if @last}}, {{/if}}{{/each}}
    policy.mcm.ibm.com/categories: {{#each categories}}{{ this }}{{^if @last}}, {{/if}}{{/each}}
    policy.mcm.ibm.com/controls: {{#each controls}}{{ this }}{{^if @last}}, {{/if}}{{/each}}
spec:
  complianceType: musthave
  remediationAction: {{#if enforce}}enforce{{else}}inform{{/if}}
  disabled: {{#if disabled}}true{{else}}false{{/if}}
  {{#if namespaceSelector}}
  {{namespaceSelector}}
  {{else}}
  namespaces:
    exclude: ["kube-*"]
    include: ["default"]
  {{/if}}
  {{! If user modifies one of these specs, editor captures those changes and will insert here on re-render}}
  {{#if specsCapture}}
{{{specsCapture}}}
  {{else}}
  {{#if roleTemplates.length}}
  role-templates:
    {{#each roleTemplates}}
    {{{ this }}}
    {{/each}}
  {{/if}}
  {{#if objectTemplates.length}}
  object-templates:
    {{#each objectTemplates}}
    {{{ this }}}
    {{/each}}
  {{/if}}
  {{#if policyTemplates.length}}
  policy-templates:
    {{#each policyTemplates}}
    {{{ this }}}
    {{/each}}
  {{/if}}
  {{/if}}
---
apiVersion: mcm.ibm.com/v1alpha1
kind: PlacementBinding
metadata:
  name: binding-{{name}}
  namespace: {{namespace}}
placementRef:
  name: placement-{{name}}
  kind: PlacementRule
  apiGroup: apps.open-cluster-management.io
subjects:
- name: {{name}}
  kind: Policy
  apiGroup: policy.mcm.ibm.com
---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  name: placement-{{name}}
  namespace: {{namespace}}
spec:
  clusterConditions:
  - type: OK
  clusterSelector:
    matchExpressions:
      {{#each clusters}}
      - {key: {{@key}}, operator: In, values: [{{#each this}}{{#if @index}}, {{/if}}"{{this}}"{{/each}}]}
      {{else}}
      []
      {{/each}}
